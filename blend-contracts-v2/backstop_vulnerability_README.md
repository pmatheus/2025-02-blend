# Backstop Token Valuation Vulnerability

This document explains a vulnerability in the Blend protocol related to the valuation of backstop tokens in bad debt auctions.

## Background

The backstop pool contains LP tokens that represent a combination of BLND and USDC. In normal circumstances, these LP tokens maintain a ratio of approximately 80% USDC and 20% BLND by value.

## The Vulnerability

The issue occurs in the bad debt auction mechanism, where the contract uses a fixed multiplier of 5 to value the backstop tokens based on their USDC content:

```rust
let backstop_value_base = pool_backstop_data
    .usdc
    .fixed_mul_floor(e, &oracle_scalar, &SCALAR_7) // adjust for oracle scalar
    * 5; // Since the backstop LP token is an 80/20 split of USDC/BLND
```

This approach assumes that:
1. The USDC content represents 80% of the total value
2. The BLND content represents the other 20% of the value
3. Therefore, multiplying the USDC by 5 should give the total value (since 5 * 80% = 100%)

However, this assumption breaks down if the actual ratio of USDC to BLND changes from the expected 80/20 split.

## How It Can Be Exploited

An attacker can manipulate the composition of the backstop LP token to be heavily BLND-weighted, for example:
- 99% BLND by value
- 1% USDC by value

When the contract calculates the value based on the USDC multiplier (× 5), it severely undervalues the actual LP tokens, because the USDC portion no longer represents 80% of the value.

During a bad debt auction, the number of LP tokens needed to cover a debt is calculated based on this valuation. With the manipulated LP composition, an attacker would need to provide far fewer LP tokens than they should actually need to cover the debt.

## Proof of Concept

A demonstration test is included in `test-suites/tests/backstop_exploit.rs` that:

1. Shows the initial backstop state with a reasonable USDC/BLND ratio
2. Simulates a manipulated state with extreme BLND weighting
3. Calculates and compares the valuations using:
   - The vulnerable contract formula (USDC × 5)
   - The actual value (BLND + USDC × 4), assuming USDC is worth 4× BLND
4. Shows how many LP tokens would be required in a bad debt auction
5. Demonstrates the significant discount an attacker would receive

## Impact

When the backstop tokens are undervalued, an attacker can obtain a significant discount (95% or more) during bad debt auctions. This allows them to:

1. Acquire assets at a fraction of their actual value
2. Drain value from the protocol
3. Potentially make large profits at the expense of other participants

## Recommended Fix

Consider the following approaches to fix this vulnerability:

1. **Dynamic Calculation**: Calculate the true value based on the actual current composition of BLND and USDC in the LP token, rather than using a fixed multiplier.

2. **Oracle-Based Valuation**: Use price oracles to determine the actual value of both the BLND and USDC components independently.

3. **Composition Limits**: Implement checks to ensure the USDC/BLND ratio remains within acceptable boundaries, rejecting transactions that would create extreme imbalances.

4. **Periodic Rebalancing**: Include mechanisms to periodically rebalance the backstop pool to maintain the intended 80/20 ratio.
